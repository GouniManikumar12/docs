---
title: "Weave Ad Format"
description: "Integrate AdMesh recommendations into LLM responses using admesh-weave-node"
---

## Overview

The **Weave Ad Format** enables you to weave AdMesh recommendations directly into your LLM generated responses. Using `@admesh/weave-node`, you get:

- **Fast retrieval** - efficiently retrieves recommendations with low latency
- **Simple integration** - clean API with minimal configuration
- **Full control** - format recommendations exactly how you want
- **LLM integration** - pass recommendations to your LLM for natural weaving
- **Graceful fallback** - works seamlessly even if recommendations are not available

**Setup time:** 15 to 30 minutes | **Code complexity:** Simple

## When to Use Weave Ad Format

Use Weave Ad Format if you want to:
- Weave recommendations into LLM generated responses
- Have full control over recommendation formatting
- Build custom conversational ad experiences
- Integrate recommendations into your backend LLM pipeline

---

## Installation

```bash
npm install @admesh/weave-node
```

---

## Quick Start

### Basic Usage

```typescript
import { AdMeshClient } from '@admesh/weave-node';

const client = new AdMeshClient({
  apiKey: process.env.ADMESH_API_KEY
});

const result = await client.getRecommendationsForWeave({
  sessionId: 'your-session-id',
  messageId: 'your-message-id',
  query: 'best laptops for programming',
  timeoutMs: 30000
});

if (result.found) {
  console.log('Recommendations:', result.recommendations);
} else {
  console.log('No recommendations found:', result.error);
}
```

---

## Integration Guide

### Step 1: Initialize

```typescript
const client = new AdMeshClient({
  apiKey: process.env.ADMESH_API_KEY
});
```

### Step 2: Fetch Recommendations

```typescript
async function getRecs(sessionId, messageId, query) {
  const result = await client.getRecommendationsForWeave({
    sessionId,
    messageId,
    query,
    timeoutMs: 30000
  });
  return result.found ? result.recommendations : null;
}
```

### Step 3: Format for LLM

To help your LLM naturally weave ads into responses, we **recommend passing** `product_title`, `product_description`, and `click_url` for each recommendation.

```typescript
function formatRecommendationsForLLM(recs, userQuery) {
  const formatted = recs
    .map(r => 
      `- ${r.product_title}
  Description: ${r.product_description}
  Link: ${r.click_url}`
    )
    .join('\n\n');

  return `
${userQuery}

=== WEAVE RECOMMENDATIONS (Integrate these naturally into your response) ===
Each recommendation includes title, description, and click URL.
Pass all three fields to your LLM for best contextual blending.
Format mentions as: [Product Name](link)<sub>[Ad]</sub>

${formatted}
`;
}
```

**Why this matters:**
- Including `product_description` helps the LLM understand *why* a product is relevant.  
- Keeping `click_url` intact ensures correct attribution and tracking.  
- `product_title` improves readability and accuracy when mentioned in the response.  

### Step 4: Combine with LLM

```typescript
async function generateLLMResponse(sessionId, messageId, query) {
  const recs = await getRecs(sessionId, messageId, query);
  const prompt = recs ? formatRecommendationsForLLM(recs, query) : query;
  const llmResponse = await callYourLLM(prompt);
  return llmResponse;
}
```

---

## Best Practices

✅ **Do**
- Provide clear, specific queries  
- Pass `product_description`, `product_title`, and `click_url` to your LLM  
- Handle errors gracefully and use fallbacks  
- Reuse session IDs across messages  
- Always send exposure events using `exposure_url`

❌ **Don't**
- Modify tracking links  
- Skip exposure events  
- Use very short timeouts  
- Create new sessions for every message

---

## Example Integration

```typescript
import express from 'express';
import { AdMeshClient } from '@admesh/weave-node';

const app = express();
app.use(express.json());

const admeshClient = new AdMeshClient({
  apiKey: process.env.ADMESH_API_KEY!
});

app.post('/api/chat', async (req, res) => {
  const { sessionId, messageId, query } = req.body;
  try {
    const result = await admeshClient.getRecommendationsForWeave({
      sessionId, messageId, query, timeoutMs: 30000
    });

    let prompt = query;
    if (result.found && result.recommendations) {
      const recs = result.recommendations
        .map(r => `- ${r.product_title}: ${r.click_url}`)
        .join('\n');
      prompt = `${query}\n\n=== WEAVE RECOMMENDATIONS ===\n${recs}`;
    }

    const llmResponse = await callYourLLM(prompt);
    res.json({ response: llmResponse, recommendations: result.recommendations || [] });

  } catch (err) {
    console.error('Error:', err);
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.listen(3000, () => console.log('Server running on port 3000'));
```

---
